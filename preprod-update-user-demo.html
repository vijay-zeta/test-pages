<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>clearIdentified demo</title>
  </head>
  <body>
    <script async type="text/javascript">
    function zync_call() {
        var z = document.createElement("script");
        var gpp="${GPP_STRING_469}";
        var gpp_sid="${GPP_SID}";
        var gdpr="${GDPR}";
        var gdpr_consent="${GDPR_CONSENT_469}";
        var zmpID="vijay-sandbox";
        var cache_buster=Date.now();
        var PageUrl=encodeURIComponent(window.top.location.href).replace(/[!'()~]/g, escape).replace(/\*/g, "%2A"); // This macro contains JavaScript that is compatible with most web browsers. If your deployment uses a tag manager, please ensure compatibility with your specific implementation

        var z_src = "https://zync-kafka-external.dev.zetaglobal.io/sync?c=16b6410431b6374e780104abb0443ca8&p=cf8c608688e49da8b728ca1f02a09f0d&k=vijay-sandbox-pixel-6621&gpp="+gpp+"&gpp_sid="+gpp_sid+"&gdpr="+gdpr+"&gdpr_consent="+gdpr_consent+"&zmpID="+zmpID+"&cache_buster="+cache_buster+"&PageUrl="+PageUrl;
        z.setAttribute("src", z_src);
        document.body.appendChild(z);
    }

    if (['complete', 'interactive'].indexOf(document.readyState) >= 0) {
        zync_call();
    } else {
        window.addEventListener("DOMContentLoaded", function(){
            zync_call();
        });
    }
    </script>
    <script>
    (function () {
      const sleep = (ms) => new Promise((r) => setTimeout(r, ms));
    
      const waitForBT = (timeoutMs = 15000, intervalMs = 200) =>
        new Promise((resolve, reject) => {
          const start = Date.now();
          (function poll() {
            if ((window.bt && typeof window.bt === "function") || window._bt) {
              resolve();
              return;
            }
            if (Date.now() - start > timeoutMs) {
              reject(new Error("Timed out waiting for bt/_bt"));
              return;
            }
            setTimeout(poll, intervalMs);
          })();
        });
    
      const randomCustId = () => Math.floor(Math.random() * 100000).toString();
      const randomEmail = () =>
        `user${Math.floor(Math.random() * 100000)}@example.com`;

      (function wrapConsoleOnce() {
          if (window.__btDemoConsoleWrapped) return;
          window.__btDemoConsoleWrapped = true;
      
          const origLog = console.log;
          console.log = function (...args) {
            // Always preserve
            try {
              const logs = JSON.parse(sessionStorage.getItem("bt_demo_logs") || "[]");
              const line = args.map(a => (typeof a === "object" ? JSON.stringify(a, null, 2) : String(a))).join(" ");
              logs.push(line);
              sessionStorage.setItem("bt_demo_logs", JSON.stringify(logs));
            } catch (_) {}
      
            // Only print if not muted
            const muted = window.__btDemoMuteConsole || sessionStorage.getItem("bt_demo_mute") === "1";
            if (!muted) origLog.apply(console, args);
          };
        })();

      function replayLogs() {
          const logs = JSON.parse(sessionStorage.getItem("bt_demo_logs") || "[]");
          if (logs.length) {
            console.log("%cReplaying preserved logs from before reload:", "color:blue;font-weight:bold;");
            logs.forEach((msg) => console.log(msg));
            sessionStorage.removeItem("bt_demo_logs"); // clear after replay
          }
      }
    
      function updateUserPromise({ custId, email, clearIdentified = false }) {
        return new Promise((resolve) => {
          const call = window.bt
            ? window.bt
            : (window._bt && typeof window._bt.bt === "function"
                ? window._bt.bt.bind(window._bt)
                : null);
    
          if (!call) {
            console.error("bt function not found");
            resolve({ ok: false, error: "bt function not found" });
            return;
          }
    
          call(
            "updateUser",
            {
              "unique_client_ids": [{ name: "cust_id", value: custId }],
              "email": email,
              "clearIdentified": clearIdentified
            },
            {
              onSuccess: () => {
                console.log(
                  `%cupdateUser succeeded (cust_id=${custId}, email=${email}, clearIdentified=${clearIdentified})`,
                  "color:green;font-weight:bold;"
                );
                console.log(JSON.stringify(_bt._identity, null, 2));
                resolve({ ok: true });
              },
              onFailure: (error) => {
                console.log(
                  `%cupdateUser failed (cust_id=${custId}, email=${email}, clearIdentified=${clearIdentified})`,
                  "color:red;font-weight:bold;",
                  error
                );
                resolve({ ok: false, error });
              }
            }
          );
        });
      }
    
    // --- log preservation ---
      function preserveLog(message) {
        const logs = JSON.parse(sessionStorage.getItem("bt_demo_logs") || "[]");
        logs.push(message);
        sessionStorage.setItem("bt_demo_logs", JSON.stringify(logs));
      }
    
      function replayLogs() {
        const logs = JSON.parse(sessionStorage.getItem("bt_demo_logs") || "[]");
        if (logs.length) {
          console.log("%cReplaying preserved logs from before reload:", "color:blue;font-weight:bold;");
          logs.forEach((msg) => console.log(msg));
          sessionStorage.removeItem("bt_demo_logs"); // clear after replay
        }
      }
    
      async function run() {
        try {
          await waitForBT();
    
          const alreadyReloaded = sessionStorage.getItem("bt_ee_reloaded");
    
          if (!alreadyReloaded) {
            // ðŸ”‡ Mute printing on first load; still preserve to storage
            window.__btDemoMuteConsole = true;
            sessionStorage.setItem("bt_demo_mute", "1");
    
            // 1) Random with clearIdentified=true (with email)
            const custId1 = randomCustId();
            const email1 = randomEmail();
            await updateUserPromise({ custId: custId1, email: email1, clearIdentified: true });
            await sleep(500);
    
            // 2) Random with clearIdentified=false (no email)
            const custId2 = randomCustId();
            await updateUserPromise({ custId: custId2, clearIdentified: false });
            await sleep(500);
    
            // 3) Random with clearIdentified=true (no email)
            const custId3 = randomCustId();
            await updateUserPromise({ custId: custId3, clearIdentified: true });
            await sleep(500);
    
            // 4) Reuse same as #2, but with clearIdentified=true
            await updateUserPromise({ custId: custId2, clearIdentified: true });
            await sleep(500);
    
            // 5) Reload once with bt_ee=<first email>
            const url = new URL(window.location.href);
            url.searchParams.set("bt_ee", email1);
            sessionStorage.setItem("bt_ee_reloaded", "1");
            console.log(`%cReloading with bt_ee=${email1}`, "color:purple;font-weight:bold;");
            window.location.replace(url.toString());
    
          } else {
            // ðŸ”Š Unmute on second load, replay stored logs, then clear flags
            window.__btDemoMuteConsole = false;
            sessionStorage.removeItem("bt_demo_mute");

            replayLogs();
            
            console.log("bt_ee param:", new URL(window.location.href).searchParams.get("bt_ee"));
            console.log(JSON.stringify(_bt._identity, null, 2));
    
            // clear the reload flag so future runs start fresh
            sessionStorage.removeItem("bt_ee_reloaded");
          }
        } catch (e) {
          console.error("Failed to run tests:", e);
        }
      }
      
     run();
   })();
   </script>
  </body>
</html>
